generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  individual
  enterprise_admin
  enterprise_participant
  studio_creator
  platform_admin
}

enum SubscriptionTier {
  free
  pro_monthly
  pro_annual
  enterprise
}

enum OrgPlan {
  pilot
  standard
  enterprise
}

enum OrgMemberRole {
  admin
  participant
}

enum SimulationStatus {
  draft
  review
  staged
  published
  archived
}

enum Difficulty {
  foundational
  intermediate
  advanced
  executive
}

enum SimFormat {
  branching_narrative
  realtime_crisis
  ai_adaptive
  multiplayer_board
  unreal_3d
  unity_3d
  external_custom
}

enum GamePlatform {
  unreal
  unity
  web
  other
}

enum GameEventType {
  decision
  milestone
  score_update
  completion
  custom
}

enum SessionStatus {
  in_progress
  completed
  abandoned
}

enum AssignmentStatus {
  assigned
  in_progress
  completed
  overdue
}

// ─── Core Tables ────────────────────────────────────

model User {
  id               String           @id @default(uuid()) @db.Uuid
  clerkId          String           @unique @map("clerk_id")
  email            String
  name             String           @default("")
  role             UserRole         @default(individual)
  organizationId   String?          @map("organization_id") @db.Uuid
  subscriptionTier SubscriptionTier @default(free) @map("subscription_tier")
  stripeCustomerId String?          @map("stripe_customer_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  organization        Organization?        @relation(fields: [organizationId], references: [id])
  orgMemberships      OrgMembership[]
  sessions            Session[]
  assignedSimulations SimulationAssignment[] @relation("assignedTo")
  assignedByMe        SimulationAssignment[] @relation("assignedBy")
  authoredSimulations Simulation[]

  @@map("users")
}

model Organization {
  id                   String   @id @default(uuid()) @db.Uuid
  name                 String
  slug                 String   @unique
  plan                 OrgPlan  @default(pilot)
  seatLimit            Int      @default(25) @map("seat_limit")
  stripeSubscriptionId String?  @map("stripe_subscription_id")
  ssoEnabled           Boolean  @default(false) @map("sso_enabled")
  ssoProvider          String?  @map("sso_provider")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  users       User[]
  memberships OrgMembership[]
  sessions    Session[]
  assignments SimulationAssignment[]

  @@map("organizations")
}

model OrgMembership {
  id             String        @id @default(uuid()) @db.Uuid
  userId         String        @map("user_id") @db.Uuid
  organizationId String        @map("organization_id") @db.Uuid
  role           OrgMemberRole @default(participant)
  department     String?
  joinedAt       DateTime      @default(now()) @map("joined_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("org_memberships")
}

// ─── Simulation Content ─────────────────────────────

model Simulation {
  id                  String           @id @default(uuid()) @db.Uuid
  title               String
  slug                String           @unique
  description         String           @default("")
  category            String
  skillTags           String[]         @map("skill_tags")
  difficulty          Difficulty       @default(intermediate)
  format              SimFormat        @default(branching_narrative)
  status              SimulationStatus @default(draft)
  thumbnailUrl        String?          @map("thumbnail_url")
  estimatedDurationMin Int?            @map("estimated_duration_min")
  authorId            String?          @map("author_id") @db.Uuid
  scoringConfig       Json?            @map("scoring_config")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  publishedAt         DateTime?        @map("published_at")

  author      User?                @relation(fields: [authorId], references: [id])
  modules     Module[]
  assignments SimulationAssignment[]

  @@map("simulations")
}

model Module {
  id                  String           @id @default(uuid()) @db.Uuid
  simulationId        String           @map("simulation_id") @db.Uuid
  title               String
  slug                String
  sortOrder           Int              @default(0) @map("sort_order")
  narrativeContext    String?          @map("narrative_context") @db.Text
  stakeholders        Json?
  isFreeDemo          Boolean          @default(false) @map("is_free_demo")
  estimatedDurationMin Int?            @map("estimated_duration_min")
  status              SimulationStatus @default(draft)
  createdAt           DateTime         @default(now()) @map("created_at")
  launchUrl           String?          @map("launch_url")
  platform            GamePlatform?
  buildVersion        String?          @map("build_version")

  simulation  Simulation   @relation(fields: [simulationId], references: [id], onDelete: Cascade)
  mediaAssets MediaAsset[]
  sessions    Session[]

  @@unique([simulationId, slug])
  @@map("modules")
}

model MediaAsset {
  id              String   @id @default(uuid()) @db.Uuid
  moduleId        String   @map("module_id") @db.Uuid
  type            String
  url             String
  filename        String
  sizeBytes       BigInt?  @map("size_bytes")
  durationSeconds Int?     @map("duration_seconds")
  uploadedAt      DateTime @default(now()) @map("uploaded_at")

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("media_assets")
}

// ─── Sessions & Game Events ─────────────────────────

model Session {
  id                   String        @id @default(uuid()) @db.Uuid
  userId               String        @map("user_id") @db.Uuid
  moduleId             String        @map("module_id") @db.Uuid
  organizationId       String?       @map("organization_id") @db.Uuid
  status               SessionStatus @default(in_progress)
  startedAt            DateTime      @default(now()) @map("started_at")
  completedAt          DateTime?     @map("completed_at")
  totalDurationSeconds Int?          @map("total_duration_seconds")
  finalScores          Json?         @map("final_scores")
  debriefText          String?       @map("debrief_text") @db.Text
  debriefGeneratedAt   DateTime?     @map("debrief_generated_at")
  externalSessionId    String?       @unique @map("external_session_id")
  platform             GamePlatform?
  launchUrl            String?       @map("launch_url")

  user         User          @relation(fields: [userId], references: [id])
  module       Module        @relation(fields: [moduleId], references: [id])
  organization Organization? @relation(fields: [organizationId], references: [id])
  gameEvents   GameEvent[]

  @@index([userId])
  @@index([moduleId])
  @@index([organizationId])
  @@index([externalSessionId])
  @@map("sessions")
}

model GameEvent {
  id         String        @id @default(uuid()) @db.Uuid
  sessionId  String        @map("session_id") @db.Uuid
  eventType  GameEventType @map("event_type")
  eventData  Json          @map("event_data")
  timestamp  DateTime      @default(now())
  receivedAt DateTime      @default(now()) @map("received_at")

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventType])
  @@map("game_events")
}

// ─── API Keys (Game Engine Auth) ────────────────────

model ApiKey {
  id             String    @id @default(uuid()) @db.Uuid
  name           String
  keyHash        String    @unique @map("key_hash")
  keyPrefix      String    @map("key_prefix")
  simulationId   String?   @map("simulation_id") @db.Uuid
  organizationId String?   @map("organization_id") @db.Uuid
  scopes         String[]  @default(["game:write"])
  isActive       Boolean   @default(true) @map("is_active")
  lastUsedAt     DateTime? @map("last_used_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  expiresAt      DateTime? @map("expires_at")

  @@map("api_keys")
}

// ─── Enterprise Features ────────────────────────────

model SimulationAssignment {
  id               String           @id @default(uuid()) @db.Uuid
  organizationId   String           @map("organization_id") @db.Uuid
  assignedByUserId String           @map("assigned_by_user_id") @db.Uuid
  assignedToUserId String           @map("assigned_to_user_id") @db.Uuid
  simulationId     String           @map("simulation_id") @db.Uuid
  dueDate          DateTime?        @map("due_date") @db.Date
  status           AssignmentStatus @default(assigned)
  assignedAt       DateTime         @default(now()) @map("assigned_at")

  organization Organization @relation(fields: [organizationId], references: [id])
  assignedBy   User         @relation("assignedBy", fields: [assignedByUserId], references: [id])
  assignedTo   User         @relation("assignedTo", fields: [assignedToUserId], references: [id])
  simulation   Simulation   @relation(fields: [simulationId], references: [id])

  @@index([organizationId])
  @@index([assignedToUserId])
  @@map("simulation_assignments")
}
